## TCP 커넥션
모든 HTTP 통신은 TCP/IP 위에서 이루어진다. 세계 어디서든 클라이언트 어플리케이션은 서버 어플리케이션으로 TCP/IP 커넥션은 맺을 수 있다.
일단 커넥션이 맺어지면 클라이언트와 서버 컴퓨터 간에 주고받는 메시지들은 손실 혹은 손상되거나 순서가 바뀌지 않고 안전하게 전달된다.

## 브라우저에 URL을 입력했을 때 일어나는 일
ex) http://www.joes-hardware.com:80/index.html

1. 브라우저가 www.joes-hardware.com의 호스트명을 추출한다.
2. 브라우저가 www.joes-hardware.com의 IP 주소를 찾는다.
3. 브라우저가 포트 번호를 얻는다.
4. 브라우저가 IP와 포트로 TCP 커넥션을 생성한다.
5. 브라우저가 서버로 HTTP GET 요청 메시지를 보낸다.
6. 브라우저가 서버에서 온 HTTP 응답 메시지를 읽는다.
7. 브라우저가 커넥션을 끊는다.

## TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다
TCP는 IP 패킷이라고 불리는 작은 조각을 통해 데이터를 전송한다.
```
├── http
├── tcp
├── ip
├── ethernet
http의 구조

├── http
├── tsl or ssl
├── tcp
├── ip
├── ethernet
https의 구조
```
http가 메시지를 전송하고자 할 경우, 현재 연결되어 있는 TCP 커넥션을 통해서 메시지 데이터의 내용을 순서대로 보낸다. TCP는 세그먼트라는 단위로 데이터 스트림을 
잘게 나누고, 세그먼트를 IP 패킷이라고 불리는 봉투에 담아서 인터넷을 통해 데이터를 전달한다. 이 모든 것은 TCP/IP 소프트웨어에 의해 처리된다.

각 TCP 세그먼트는 하나의 IP 주소에서 다른 IP 주소로 패킷에 담겨 전달된다. 이 IP 패킷들 각각은 다음을 포함한다.
- IP 패킷 헤더
- TCP 세그먼트 헤더
- TCP 데이터 조각

## TCP 커넥션 유지하기
컴퓨터는 항상 TCP 커넥션을 여러 개 가지고 있다. TCP는 포트 번호를 통해서 이런 여러 개의 커넥션을 유지한다.

TCP 커넥션은 네 가지 값으로 식별한다.
```
<발신지 IP 주소, 발신지 포트 번호, 수신지 IP 주소, 수신지 포트 번호>
```
위 네 가지 값으로 유일한 커넥션을 생성한다. 서로 다른 두 개의 TCP 커넥션은 네 가지 주소 구성요소의 값이 모두 같을 수 없다.

## TCP 소켓 프로그래밍
운영체제는 TCP 커넥션의 생성과 관련된 여러 기능을 제공한다. 소켓 API는 개발자에게 TCP와 IP의 세부사항을 숨긴다.
- s = socket() : 소켓을 생성한다.
- bind(s, local_addr, local_port) : 소켓에 로컬 포트 번호와 인터페이스 할당
- connect(s, remote_addr, remote_port) : 로컬의 소켓과 원격의 호스트 및 포트 사이에 TCP 커넥션 생성
- listen(s, backlog) : 커넥션을 위한 대기열을 생성하고, 커넥션 요청을 대기한다.
- s2 = accept(s) : 누군가 로컬 포트에 커넥션을 맺기를 기다림
- n = read(s, buffer, length) : 소켓으로부터 버퍼에 n바이트 읽기 시도
- n = write(s, buffer, length) : 소켓으로부터 버퍼에 n바이트 쓰기 시도
- close(s) : TCP 커넥션을 완전히 끊음
- shutdown(s, mode) : TCP 커넥션의 입출력만 닫음
- getsockopt(s, option) : 내부 소켓의 설정된 옵션을 얻음
- setsockopt(s, option) : 내부 소켓의 옵션을 설정함

소켓 API를 사용하면 TCP 엔드 포인트 데이터 구조를 생성하고, 원격 서버의 TCP 엔드 포인트 데이터 구조를 연결하여 데이터 스트림을 읽고 쓸 수 있다.

## TCP 커넥션을 맺는 과정
s: 서버 / c: 클라이언트
- s1: 새로운 소켓을 만든다. (socket())
- s2: 80 포트로 소켓을 묶는다
- s3: 소켓 커넥션을 허가한다 (listen())
- s4: 커넥션을 기다린다 (accept())
- c1: IP 주소와 포트를 얻는다
- c2: 새로운 소켓을 생성한다 (socket())
- c3: 서버의 IP:포트로 연결한다 (connect())
- s5: 어플리케이션 커넥션 통지
  - c4: 성공적으로 연결
- s6: 요청을 읽기 시작한다(read())
- c5: HTTP 요청을 보낸다(write())
  - s7: HTTP 요청 메시지를 처리한다
- c6: HTTP 응답을 기다린다(read())
- s8: HTTP 응답을 보낸다(write())
  - c7: HTTP 응답 메시지를 처리한다
- c8: 커넥션을 닫는다(close())
- s9: 커넥션을 닫는다(close())

## TCP 성능에 대한 고려
HTTP는 TCP 바로 위에 있는 계층이기 때문에 HTTP 트랜잭션의 성능은 그 아래 계층인 TCP의 성능에 영향을 받는다.